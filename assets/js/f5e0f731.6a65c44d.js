"use strict";(self.webpackChunkp_my_dm=self.webpackChunkp_my_dm||[]).push([[6070],{651:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>t});const a=JSON.parse('{"id":"python/UT7 - Persistencia/7.3 BBDD/7.3.5_transacciones_errores","title":"7.3.5 Transacciones y Manejo de Errores","description":"En una base de datos profesional, las cosas pueden fallar: se corta la luz, se pierde la conexi\xf3n, o un dato es incorrecto. Si estamos realizando una operaci\xf3n compleja (como mover dinero de una cuenta a otra o mover un libro de una estanter\xeda a otra), no podemos permitir que la operaci\xf3n se quede a medias.","source":"@site/docs/python/UT7 - Persistencia/7.3 BBDD/7.3.5_transacciones_errores.md","sourceDirName":"python/UT7 - Persistencia/7.3 BBDD","slug":"/python/UT7 - Persistencia/7.3 BBDD/7.3.5_transacciones_errores","permalink":"/docs/python/UT7 - Persistencia/7.3 BBDD/7.3.5_transacciones_errores","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"pythonSidebar","previous":{"title":"7.3.4 Relaciones e Integridad de Datos","permalink":"/docs/python/UT7 - Persistencia/7.3 BBDD/7.3.4_relaciones_integridad"}}');var i=r(4848),s=r(8453);const o={sidebar_position:6},c="7.3.5 Transacciones y Manejo de Errores",l={},t=[{value:"<strong>1\ufe0f\u20e3 El Concepto: Atomicidad (ACID)</strong>",id:"1\ufe0f\u20e3-el-concepto-atomicidad-acid",level:2},{value:"\ud83d\udfe9 <code>commit()</code> \u2014 La confirmaci\xf3n",id:"-commit--la-confirmaci\xf3n",level:3},{value:"\ud83d\udfe6 <code>rollback()</code> \u2014 La marcha atr\xe1s",id:"-rollback--la-marcha-atr\xe1s",level:3},{value:"<strong>2\ufe0f\u20e3 Gesti\xf3n Manual de Transacciones</strong>",id:"2\ufe0f\u20e3-gesti\xf3n-manual-de-transacciones",level:2},{value:"<strong>3\ufe0f\u20e3 Gesti\xf3n Autom\xe1tica: El Context Manager</strong>",id:"3\ufe0f\u20e3-gesti\xf3n-autom\xe1tica-el-context-manager",level:2},{value:"<strong>4\ufe0f\u20e3 Jerarqu\xeda de Excepciones de SQLite</strong>",id:"4\ufe0f\u20e3-jerarqu\xeda-de-excepciones-de-sqlite",level:2},{value:"<strong>5\ufe0f\u20e3 El Problema de la Base de Datos Bloqueada</strong>",id:"5\ufe0f\u20e3-el-problema-de-la-base-de-datos-bloqueada",level:2},{value:"<strong>\u2705 Buenas pr\xe1cticas en Transacciones</strong>",id:"-buenas-pr\xe1cticas-en-transacciones",level:2},{value:"<strong>\ud83e\uddea Ejercicios pr\xe1cticos</strong> \u2013 Misi\xf3n: La Cripta de Datos (Parte Final)",id:"-ejercicios-pr\xe1cticos--misi\xf3n-la-cripta-de-datos-parte-final",level:2},{value:"\ud83d\udfe2 Fase 1 \u2013 Blindaje At\xf3mico",id:"-fase-1--blindaje-at\xf3mico",level:3},{value:"\ud83d\udfe9 Ejercicio 1 \u2013 El Pr\xe9stamo Seguro",id:"-ejercicio-1--el-pr\xe9stamo-seguro",level:4},{value:"\ud83d\udfe6 Ejercicio 2 \u2013 Simulacro de Fallo",id:"-ejercicio-2--simulacro-de-fallo",level:4},{value:"\ud83d\udfe1 Fase 2 \u2013 Diagn\xf3stico y Limpieza",id:"-fase-2--diagn\xf3stico-y-limpieza",level:3},{value:"\ud83d\udfe8 Ejercicio 3 \u2013 El Auditor de Errores",id:"-ejercicio-3--el-auditor-de-errores",level:4},{value:"\ud83d\udfe7 Ejercicio 4 \u2013 La Cripta Corrupta",id:"-ejercicio-4--la-cripta-corrupta",level:4},{value:"\ud83d\udd34 Fase 3 \u2013 La Prueba de Fuego",id:"-fase-3--la-prueba-de-fuego",level:3},{value:"\ud83d\udfe5 Ejercicio 5 \u2013 El Migrador Masivo",id:"-ejercicio-5--el-migrador-masivo",level:4},{value:"\ud83d\udfea Ejercicio 6 \u2013 La Cripta est\xe1 a salvo",id:"-ejercicio-6--la-cripta-est\xe1-a-salvo",level:4}];function d(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"735-transacciones-y-manejo-de-errores",children:"7.3.5 Transacciones y Manejo de Errores"})}),"\n",(0,i.jsx)(n.p,{children:"En una base de datos profesional, las cosas pueden fallar: se corta la luz, se pierde la conexi\xf3n, o un dato es incorrecto. Si estamos realizando una operaci\xf3n compleja (como mover dinero de una cuenta a otra o mover un libro de una estanter\xeda a otra), no podemos permitir que la operaci\xf3n se quede a medias."}),"\n",(0,i.jsxs)(n.p,{children:["Aqu\xed es donde entran las ",(0,i.jsx)(n.strong,{children:"Transacciones"})," y un robusto ",(0,i.jsx)(n.strong,{children:"Manejo de Errores"}),"."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"1\ufe0f\u20e3-el-concepto-atomicidad-acid",children:(0,i.jsx)(n.strong,{children:"1\ufe0f\u20e3 El Concepto: Atomicidad (ACID)"})}),"\n",(0,i.jsxs)(n.p,{children:["Una transacci\xf3n es un conjunto de instrucciones que se ejecutan como una ",(0,i.jsx)(n.strong,{children:"unidad at\xf3mica"}),"."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"O todo o nada"}),": Si una sola instrucci\xf3n falla, se deshacen todas las anteriores de ese bloque."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Estado Consistente"}),': La base de datos nunca se queda en un estado "intermedio" inv\xe1lido.']}),"\n"]}),"\n",(0,i.jsxs)(n.h3,{id:"-commit--la-confirmaci\xf3n",children:["\ud83d\udfe9 ",(0,i.jsx)(n.code,{children:"commit()"})," \u2014 La confirmaci\xf3n"]}),"\n",(0,i.jsx)(n.p,{children:"Env\xeda todos los cambios pendientes al disco de forma definitiva."}),"\n",(0,i.jsxs)(n.h3,{id:"-rollback--la-marcha-atr\xe1s",children:["\ud83d\udfe6 ",(0,i.jsx)(n.code,{children:"rollback()"})," \u2014 La marcha atr\xe1s"]}),"\n",(0,i.jsxs)(n.p,{children:["Anula todos los cambios realizados desde el \xfaltimo ",(0,i.jsx)(n.code,{children:"commit"}),'. Es como un "Ctrl+Z" para la base de datos.']}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"2\ufe0f\u20e3-gesti\xf3n-manual-de-transacciones",children:(0,i.jsx)(n.strong,{children:"2\ufe0f\u20e3 Gesti\xf3n Manual de Transacciones"})}),"\n",(0,i.jsxs)(n.p,{children:["El patr\xf3n cl\xe1sico consiste en envolver nuestras operaciones en un bloque ",(0,i.jsx)(n.code,{children:"try/except"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import sqlite3\n\nconn = sqlite3.connect("biblioteca.db")\n\ntry:\n    cursor = conn.cursor()\n    # Operaci\xf3n 1: Quitar libro de la secci\xf3n antigua\n    cursor.execute("UPDATE libros SET seccion = \'archivo\' WHERE id = 1")\n    \n    # Operaci\xf3n 2: Registrar el movimiento (imaginemos que esto falla)\n    cursor.execute("INSERT INTO movimientos (libro_id, destino) VALUES (?, ?)", (1, \'archivo\'))\n    \n    # Si todo ha ido bien, confirmamos\n    conn.commit()\n    print("\u2705 Transacci\xf3n completada con \xe9xito.")\n    \nexcept sqlite3.Error as e:\n    # Si algo falla, volvemos atr\xe1s para que el libro no se quede "en el limbo"\n    conn.rollback()\n    print(f"\u274c Error en la transacci\xf3n. Cambios revertidos: {e}")\n    \nfinally:\n    conn.close()\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"3\ufe0f\u20e3-gesti\xf3n-autom\xe1tica-el-context-manager",children:(0,i.jsx)(n.strong,{children:"3\ufe0f\u20e3 Gesti\xf3n Autom\xe1tica: El Context Manager"})}),"\n",(0,i.jsxs)(n.p,{children:["En Python, el objeto ",(0,i.jsx)(n.strong,{children:"conexi\xf3n"})," puede usarse con la palabra clave ",(0,i.jsx)(n.code,{children:"with"}),". Esto simplifica enormemente el c\xf3digo:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Si el bloque ",(0,i.jsx)(n.code,{children:"with"})," termina sin errores \u27a1\ufe0f hace ",(0,i.jsx)(n.code,{children:"commit()"})," autom\xe1ticamente."]}),"\n",(0,i.jsxs)(n.li,{children:["Si el bloque lanza cualquier excepci\xf3n \u27a1\ufe0f hace ",(0,i.jsx)(n.code,{children:"rollback()"})," autom\xe1ticamente."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'with sqlite3.connect("biblioteca.db") as conn:\n    # Dentro de este bloque, la transacci\xf3n est\xe1 protegida\n    conn.execute("UPDATE libros SET stock = stock - 1 WHERE id = 1")\n    conn.execute("UPDATE ventas SET total = total + 10")\n    # No hace falta poner conn.commit(), ocurre solo al salir del \'with\'\n'})}),"\n",(0,i.jsx)(n.admonition,{title:"ojo con el Cierre",type:"warning",children:(0,i.jsxs)(n.p,{children:["F\xedjate que ",(0,i.jsx)(n.code,{children:"with conn:"})," gestiona la ",(0,i.jsx)(n.strong,{children:"transacci\xf3n"}),", pero ",(0,i.jsx)(n.strong,{children:"no cierra la conexi\xf3n"}),". Debes cerrar el archivo al terminar con ",(0,i.jsx)(n.code,{children:"conn.close()"}),"."]})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"4\ufe0f\u20e3-jerarqu\xeda-de-excepciones-de-sqlite",children:(0,i.jsx)(n.strong,{children:"4\ufe0f\u20e3 Jerarqu\xeda de Excepciones de SQLite"})}),"\n",(0,i.jsx)(n.p,{children:"No todos los errores son iguales. Capturar la excepci\xf3n correcta nos permite reaccionar mejor."}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Excepci\xf3n"}),(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Cu\xe1ndo ocurre"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.code,{children:"sqlite3.Error"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Clase base para todos los errores de SQLite."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.code,{children:"sqlite3.IntegrityError"})}),(0,i.jsxs)(n.td,{style:{textAlign:"left"},children:["Un valor repetido en un ",(0,i.jsx)(n.code,{children:"UNIQUE"}),", un ",(0,i.jsx)(n.code,{children:"NULL"})," donde no deb\xeda o una clave for\xe1nea que no existe."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.code,{children:"sqlite3.OperationalError"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Errores externos: la tabla no existe, la base de datos est\xe1 bloqueada por otro programa o el SQL tiene fallos de sintaxis."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.code,{children:"sqlite3.ProgrammingError"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Error al usar la librer\xeda (ej: cerrar la conexi\xf3n y luego intentar usar el cursor)."})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"5\ufe0f\u20e3-el-problema-de-la-base-de-datos-bloqueada",children:(0,i.jsx)(n.strong,{children:"5\ufe0f\u20e3 El Problema de la Base de Datos Bloqueada"})}),"\n",(0,i.jsxs)(n.p,{children:["SQLite solo permite que un proceso escriba a la vez. Si tienes el archivo abierto en un visor de BD y a la vez intentas escribir desde Python, podr\xedas recibir un error de ",(0,i.jsx)(n.strong,{children:'"Database is locked"'}),"."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Soluci\xf3n"}),": Aseg\xfarate de que tus transacciones sean lo m\xe1s cortas posible y de cerrar siempre las conexiones."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-buenas-pr\xe1cticas-en-transacciones",children:(0,i.jsx)(n.strong,{children:"\u2705 Buenas pr\xe1cticas en Transacciones"})}),"\n",(0,i.jsx)(n.admonition,{title:"resumen profesional",type:"tip",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Transacciones At\xf3micas"}),': Agrupa siempre las operaciones que "tengan sentido juntas". Si vendes un libro, debes bajar el stock y crear el recibo en la misma transacci\xf3n.']}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Manejo Espec\xedfico"}),": Captura ",(0,i.jsx)(n.code,{children:"IntegrityError"})," para avisar al usuario de duplicados, pero deja que otros errores (",(0,i.jsx)(n.code,{children:"OperationalError"}),") se registren en un log de sistema."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Evita el Autocommit"}),": No hagas un ",(0,i.jsx)(n.code,{children:"commit()"})," por cada l\xednea si vas a insertar miles de registros; es preferible hacer uno solo al final para ganar velocidad."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.strong,{children:["Usa ",(0,i.jsx)(n.code,{children:"with"})]}),": Siempre que sea posible, delega la gesti\xf3n del commit/rollback en el context manager de la conexi\xf3n."]}),"\n"]})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h2,{id:"-ejercicios-pr\xe1cticos--misi\xf3n-la-cripta-de-datos-parte-final",children:[(0,i.jsx)(n.strong,{children:"\ud83e\uddea Ejercicios pr\xe1cticos"})," \u2013 Misi\xf3n: La Cripta de Datos (Parte Final)"]}),"\n",(0,i.jsx)(n.p,{children:"La biblioteca secreta se enfrenta a su mayor reto: un gran terremoto de datos est\xe1 sacudiendo los cimientos digitales. Debes asegurar que el sistema sea indestructible."}),"\n",(0,i.jsx)(n.h3,{id:"-fase-1--blindaje-at\xf3mico",children:"\ud83d\udfe2 Fase 1 \u2013 Blindaje At\xf3mico"}),"\n",(0,i.jsx)(n.h4,{id:"-ejercicio-1--el-pr\xe9stamo-seguro",children:"\ud83d\udfe9 Ejercicio 1 \u2013 El Pr\xe9stamo Seguro"}),"\n",(0,i.jsxs)(n.p,{children:["Implementa una funci\xf3n ",(0,i.jsx)(n.code,{children:"prestar_libro(libro_id, socio_id)"})," que realice dos operaciones en una ",(0,i.jsx)(n.strong,{children:"\xfanica transacci\xf3n"}),":"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Cambie el estado del libro a 'prestado' en la tabla ",(0,i.jsx)(n.code,{children:"libros"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Inserte un registro en una nueva tabla ",(0,i.jsx)(n.code,{children:"prestamos"})," con la fecha y los IDs.\n",(0,i.jsx)(n.strong,{children:"Reto"}),": Aseg\xfarate de que si la inserci\xf3n falla, el libro vuelva a estar 'disponible' autom\xe1ticamente."]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"-ejercicio-2--simulacro-de-fallo",children:"\ud83d\udfe6 Ejercicio 2 \u2013 Simulacro de Fallo"}),"\n",(0,i.jsxs)(n.p,{children:["Crea un script que intente insertar 10 libros nuevos dentro de un bloque ",(0,i.jsx)(n.code,{children:"with"}),". Haz que el libro n\xfamero 7 provoque un error de integridad (por ejemplo, repitiendo un t\xedtulo UNIQUE).\nVerifica despu\xe9s si en la base de datos hay 0 libros nuevos o 6 libros. (Si lo has hecho bien, no debe haber ninguno)."]}),"\n",(0,i.jsx)(n.h3,{id:"-fase-2--diagn\xf3stico-y-limpieza",children:"\ud83d\udfe1 Fase 2 \u2013 Diagn\xf3stico y Limpieza"}),"\n",(0,i.jsx)(n.h4,{id:"-ejercicio-3--el-auditor-de-errores",children:"\ud83d\udfe8 Ejercicio 3 \u2013 El Auditor de Errores"}),"\n",(0,i.jsxs)(n.p,{children:["Crea un sistema que intente realizar varias operaciones prohibidas (borrar un autor con libros, insertar nulos, etc.). Captura cada error y gu\xe1rdalo en un archivo de texto llamado ",(0,i.jsx)(n.code,{children:"errores_cripta.log"})," con el siguiente formato:\n",(0,i.jsx)(n.code,{children:"[FECHA] - TIPO DE ERROR: [MENSAJE DEL ERROR]"})]}),"\n",(0,i.jsx)(n.h4,{id:"-ejercicio-4--la-cripta-corrupta",children:"\ud83d\udfe7 Ejercicio 4 \u2013 La Cripta Corrupta"}),"\n",(0,i.jsxs)(n.p,{children:["Ejecuta el script ",(0,i.jsx)(n.code,{children:"generador_caos.py"})," de la carpeta de recursos. Este script crear\xe1 una base de datos llamada ",(0,i.jsx)(n.code,{children:"cripta_corrupta.db"})," llena de errores (p\xe1ginas negativas, t\xedtulos nulos, tipos de datos err\xf3neos).\n",(0,i.jsx)(n.strong,{children:"Misi\xf3n"}),": Crea un script que recorra todos los libros de esa base de datos y, mediante transacciones y bloques ",(0,i.jsx)(n.code,{children:"try/except"}),', intente "limpiarlos" guard\xe1ndolos en una base de datos nueva y sana llamada ',(0,i.jsx)(n.code,{children:"cripta_sana.db"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"-fase-3--la-prueba-de-fuego",children:"\ud83d\udd34 Fase 3 \u2013 La Prueba de Fuego"}),"\n",(0,i.jsx)(n.h4,{id:"-ejercicio-5--el-migrador-masivo",children:"\ud83d\udfe5 Ejercicio 5 \u2013 El Migrador Masivo"}),"\n",(0,i.jsxs)(n.p,{children:["Usa el archivo ",(0,i.jsx)(n.code,{children:"libros_migracion.json"})," de la carpeta de recursos. Crea un script que lea los libros e intente insertarlos en bloque."]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["La inserci\xf3n debe ser ultrarr\xe1pida (usa un solo ",(0,i.jsx)(n.code,{children:"commit"})," al final)."]}),"\n",(0,i.jsxs)(n.li,{children:["Como el JSON contiene un libro corrupto, la migraci\xf3n completa debe cancelarse autom\xe1ticamente gracias al uso de un bloque ",(0,i.jsx)(n.code,{children:"with"})," de conexi\xf3n."]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"-ejercicio-6--la-cripta-est\xe1-a-salvo",children:"\ud83d\udfea Ejercicio 6 \u2013 La Cripta est\xe1 a salvo"}),"\n",(0,i.jsx)(n.p,{children:'\xa1Enhorabuena! Has completado el manual. Para finalizar, crea un script "limpiador" que:'}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Intente borrar todas las tablas de tu base de datos principal."}),"\n",(0,i.jsx)(n.li,{children:"Si falla por restricciones de clave for\xe1nea, que informe del error espec\xedfico."}),"\n",(0,i.jsx)(n.li,{children:"Al finalizar, cierre todas las conexiones de forma segura."}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>c});var a=r(6540);const i={},s=a.createContext(i);function o(e){const n=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);